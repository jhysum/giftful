# Giftful Backend Requirements

## Project Overview

Giftful's backend handles data storage, authentication, AI integration, and automated notifications for the gift planning application.

## Technical Stack

- **Framework**: Next.js
- **Database**: Supabase
- **Authentication**: Clerk
- **AI Integration**: Anthropic Claude API
- **Scheduled Tasks**: Pipedream
- **Hosting**: Vercel

## Database Schema

### Storage

- **Bucket**: "contact_images" for storing contact profile pictures

### Tables

#### users

```sql
TABLE users (
  id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  user_id TEXT NOT NULL,
  name TEXT NOT NULL,
  email TEXT NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### contacts

```sql
TABLE contacts (
  id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  name TEXT NOT NULL,
  relationship_type TEXT NOT NULL,
  interests TEXT,
  image_url TEXT,
  user_id TEXT NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### important_dates

```sql
TABLE important_dates (
  id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  contact_id BIGINT NOT NULL REFERENCES contacts(id),
  event_type TEXT NOT NULL,
  date DATE NOT NULL,
  user_id TEXT NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### gift_suggestions

```sql
TABLE gift_suggestions (
  id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  contact_id BIGINT NOT NULL REFERENCES contacts(id),
  name TEXT NOT NULL,
  description TEXT NOT NULL,
  price NUMERIC NOT NULL,
  is_favorite BOOLEAN DEFAULT FALSE,
  user_id TEXT NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

## Core Requirements

### 1. User Management

- Handle user authentication via Clerk
- Create user record in database after Clerk signup
- Validate user existence before operations
- Pass user_id to relevant functions

### 2. Contact Management

- Store contact details in "contacts" table
- Handle contact image uploads to Supabase storage
- Update contact records with image URLs
- Associate contacts with creator's user_id

### 3. Date Management

- Store important dates in "important_dates" table
- Enable date proximity queries (30-day window)
- Maintain contact relationships for data joins
- Support various event types (birthdays, anniversaries)

### 4. Gift Suggestions

- Integrate with Claude AI for gift ideas
- Store suggestions in "gift_suggestions" table
- Link suggestions to specific contacts
- Support favorite/unfavorite functionality

## API Endpoints

### Gift Suggestions API

- **Route**: `/api/gift-suggestions`
- **Method**: POST
- **Input**:
  ```typescript
  {
    relationship: string;
    interests?: string;
  }
  ```
- **Output**:
  ```typescript
  {
    suggestions: Array<{
      name: string;
      description: string;
      price: number;
    }>;
  }
  ```
- **Features**:
  - Claude AI integration
  - Price range: $20-$100
  - Returns 3 suggestions per request

### Notification API

- **Route**: `/api/notify`
- **Purpose**: Handle email notifications
- **Trigger**: Pipedream workflow
- **Function**: Send notifications for events 7 days away

## Environment Configuration

Required environment variables:

- `NEXT_PUBLIC_SUPABASE_URL`
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- `SUPABASE_SERVICE_ROLE_KEY`
- `ANTHROPIC_API_KEY`

## Implementation Examples

### Supabase Storage Upload

```javascript
import { createClient } from "@supabase/supabase-js";

const supabase = createClient("your_project_url", "your_supabase_api_key");

async function uploadFile(file) {
  const { data, error } = await supabase.storage
    .from("contact_images")
    .upload("file_path", file);
  if (error) {
    // Handle error
  } else {
    // Handle success
    return data.path;
  }
}
```

### Claude AI Integration

```javascript
import Anthropic from "@anthropic-ai/sdk";

const anthropic = new Anthropic({
  apiKey: process.env.ANTHROPIC_API_KEY,
});

async function getGiftSuggestions(relationship, interests) {
  const response = await anthropic.messages.create({
    model: "claude-3-haiku-20240307",
    max_tokens: 1000,
    system: "You are a helpful gift suggestion assistant.",
    messages: [
      {
        role: "user",
        content: `Suggest 3 gift ideas for a ${relationship} who enjoys ${interests}.`,
      },
    ],
  });

  return parseGiftSuggestions(response.content[0].text);
}
```

### Event Notification System

```javascript
async function findUpcomingEvents() {
  const today = new Date();
  const nextWeek = new Date();
  nextWeek.setDate(today.getDate() + 7);

  const { data, error } = await supabase
    .from("important_dates")
    .select("*, contacts(name)")
    .gte("date", today.toISOString().split("T")[0])
    .lte("date", nextWeek.toISOString().split("T")[0]);

  return data;
}
```
